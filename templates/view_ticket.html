{% extends "base.html" %}

{% block title %}Ticket {{ ticket.ticket_number }} - GTN Engineering IT Helpdesk{% endblock %}

{% block content %}
<div class="ticket-view-lite">
    <div class="container-fluid">
        <!-- Header -->
        <div class="ticket-header-lite">
            <div class="d-flex justify-content-between align-items-center">
                <div class="ticket-title-section">
                    <h3 class="ticket-number">{{ ticket.ticket_number }}</h3>
                    <h4 class="ticket-title">{{ ticket.title }}</h4>
                </div>
                <div class="header-actions">
                    {% if user.is_super_admin %}
                        <a href="{{ url_for('edit_ticket', ticket_id=ticket.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="ri-edit-line"></i> Edit
                        </a>
                    {% endif %}
                    <a href="{{ url_for('user_dashboard' if not user.is_super_admin else 'super_admin_dashboard') }}" 
                       class="btn btn-sm btn-outline-secondary">
                        <i class="ri-arrow-left-line"></i> Back
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <!-- Ticket Info Panel -->
                <div class="info-panel-lite">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">Status</span>
                            {% set status_class = {
                                'Open': 'primary',
                                'In Progress': 'warning', 
                                'Resolved': 'success',
                                'Closed': 'secondary'
                            } %}
                            <span class="badge bg-{{ status_class[ticket.status] }}">{{ ticket.status }}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Priority</span>
                            {% set priority_class = {
                                'Low': 'success',
                                'Medium': 'warning',
                                'High': 'danger', 
                                'Critical': 'dark'
                            } %}
                            <span class="badge bg-{{ priority_class[ticket.priority] }}">{{ ticket.priority }}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Category</span>
                            <span class="badge bg-secondary">{{ ticket.category }}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Created</span>
                            <span class="value">{{ ticket.created_at|to_ist }}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Submitted by</span>
                            <span class="value">{{ ticket.user_name }}</span>
                        </div>
                        {% if ticket.assigned_to %}
                        <div class="info-item">
                            <span class="label">Assigned to</span>
                            <span class="value">{{ ticket.assignee.full_name }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Description -->
                <div class="content-panel-lite">
                    <h6 class="panel-title">Description</h6>
                    <div class="description-content">
                        {{ ticket.description | nl2br }}
                    </div>
                </div>

                <!-- Attachments -->
                {% if (ticket.image_filename or ticket.attachments) and (user.is_super_admin or ticket.user_id == user.id) %}
                <div class="content-panel-lite">
                    <h6 class="panel-title">Attachments</h6>
                    {% if ticket.image_filename %}
                        <div class="attachment-preview">
                            <img src="{{ url_for('view_image', filename=ticket.image_filename) }}" 
                                 class="attachment-image" 
                                 onclick="window.open(this.src, '_blank')"
                                 alt="Ticket attachment">
                        </div>
                    {% endif %}
                    
                    {% if ticket.attachments %}
                        <div class="attachment-list-lite">
                            {% for attachment in ticket.attachments %}
                                <div class="attachment-item-lite">
                                    {% set file_ext = attachment.filename.split('.')[-1].lower() %}
                                    <i class="ri-file-line"></i>
                                    <span class="filename">{{ attachment.filename.split('_', 1)[-1] if '_' in attachment.filename else attachment.filename }}</span>
                                    <a href="{{ url_for('download_attachment', filename=attachment.filename) }}" 
                                       class="download-btn">
                                        <i class="ri-download-line"></i>
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Comments -->
                <div class="content-panel-lite">
                    <h6 class="panel-title">Comments & Updates</h6>
                    {% if ticket.comments %}
                        <div class="comments-list-lite">
                            {% for comment in ticket.comments %}
                                <div class="comment-item-lite">
                                    <div class="comment-header">
                                        <strong>{{ comment.user.full_name }}</strong>
                                        <span class="comment-time">{{ comment.created_at|to_ist }}</span>
                                    </div>
                                    <div class="comment-text">{{ comment.comment | nl2br }}</div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="no-comments">No comments yet.</p>
                    {% endif %}
                    
                    <!-- Add Comment Form -->
                    <form method="POST" action="{{ url_for('add_comment', ticket_id=ticket.id) }}" class="comment-form-lite">
                        {{ form.hidden_tag() }}
                        <div class="form-group">
                            {{ form.comment(class="form-control", rows="3", placeholder="Add a comment or update...") }}
                        </div>
                        <div class="form-actions">
                            {{ form.submit(class="btn btn-primary btn-sm") }}
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="col-lg-4">
                {% if user.is_super_admin and not ticket.assignee %}
                <!-- Quick Assign -->
                <div class="action-panel-lite">
                    <h6 class="panel-title">Quick Assign</h6>
                    <form method="POST" action="{{ url_for('assign_ticket', ticket_id=ticket.id) }}">
                        {{ assign_form.hidden_tag() }}
                        <div class="form-group">
                            {{ assign_form.assigned_to(class="form-select form-select-sm") }}
                        </div>
                        <div class="form-actions">
                            {{ assign_form.submit(class="btn btn-success btn-sm") }}
                        </div>
                    </form>
                </div>
                {% endif %}

                <!-- System Info -->
                <div class="info-panel-lite">
                    <h6 class="panel-title">System Information</h6>
                    <div class="system-info">
                        {% if ticket.user_ip_address %}
                        <div class="system-item">
                            <span class="label">IP Address</span>
                            <code>{{ ticket.user_ip_address }}</code>
                        </div>
                        {% endif %}
                        {% if ticket.user_system_name %}
                        <div class="system-item">
                            <span class="label">System Name</span>
                            <code>{{ ticket.user_system_name }}</code>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Custom filter for nl2br
    document.addEventListener('DOMContentLoaded', function() {
        const elements = document.querySelectorAll('[data-nl2br]');
        elements.forEach(function(element) {
            element.innerHTML = element.innerHTML.replace(/\n/g, '<br>');
        });
    });
</script>
{% endblock %}
